# トロリ線摩耗検測データ EDA ツール

架線設備のトロリ線残存直径（5cm ピッチ計測データ）を対象とした探索的データ分析（EDA）ツールです。
Streamlit ベースの Web アプリとして動作し、ノイズフィルタリング・信号解析・Z-Score 異常検知をインタラクティブに実行できます。

---

## 目次

1. [機能概要](#機能概要)
2. [必要環境](#必要環境)
3. [セットアップ](#セットアップ)
4. [起動方法](#起動方法)
5. [データ形式](#データ形式)
6. [画面操作ガイド](#画面操作ガイド)
7. [分析パラメータ](#分析パラメータ)
8. [HTML 出力](#html-出力)
9. [テスト実行](#テスト実行)
10. [アーキテクチャ概要](#アーキテクチャ概要)
11. [将来拡張](#将来拡張)

---

## 機能概要

| 機能 | 説明 |
|------|------|
| **データ読み込み・検証** | Excel（.xlsx）を読み込み、必須10列の存在を自動検証 |
| **ファイルアップロード** | ブラウザから任意の .xlsx ファイルをアップロードして分析（サイドバーで切り替え） |
| **CH 別摩耗チャート** | CH 1〜4 ごとのインタラクティブ摩耗チャート（ホバーで詳細属性を表示） |
| **ノイズフィルタリング** | 移動中央値フィルタ・Savitzky-Golay フィルタを ON/OFF 切り替えで適用 |
| **信号解析（RMS / FFT / STFT）** | スライドウィンドウによる統計処理で周波数特性とノイズパターンを探索 |
| **Z-Score 異常検知** | 移動平均からの乖離を定量化し、局所的な摩耗異常箇所を自動検出 |
| **統合比較ビュー** | 生波形・フィルタ後波形・Z-Score を3段連動グラフで同時比較 |
| **HTML 出力** | 分析結果をインタラクティブ HTML ファイルとして保存・共有 |

---

## 必要環境

- **Python**: 3.10 以上
- **パッケージマネージャ**: [uv](https://docs.astral.sh/uv/)
- **実行環境**: SageMaker Studio または Python 3.10+ が動作するローカル環境

---

## セットアップ

```bash
# 1. リポジトリのクローン（または対象ディレクトリに移動）
cd 5cm-chart-analysis

# 2. 仮想環境の構築と依存パッケージのインストール
uv sync

# 3. データファイルの配置
#    以下のパスに Excel ファイルを配置してください
#    data/20220916-koga-st-5cm-original-data.xlsx
```

---

## 起動方法

```bash
uv run streamlit run app.py
```

起動後、ブラウザで `http://localhost:8501` を開いてください。
SageMaker Studio では自動的にプロキシ URL が割り当てられます。

---

## データ形式

読み込む Excel ファイル（`.xlsx`）には以下の **10 列が必須** です。

| 列名 | 型 | 説明 |
|------|----|------|
| `キロ程` | 数値 | 計測位置（メートル単位） |
| `摩耗_測定値` | 数値 | トロリ線残存直径（mm） |
| `CH` | 整数（1〜4） | 計測チャンネル番号 |
| `箇所名` | テキスト | 設備箇所名 |
| `通称線名名称` | テキスト | 線路名称 |
| `駅・駅々間名称` | テキスト | 駅間名称 |
| `電柱番号` | テキスト | 電柱番号 |
| `架線構造名` | テキスト | 架線構造の種別 |
| `トロリ線種` | テキスト | トロリ線の種別 |
| `降雨フラグ` | テキスト | 計測時の降雨状態 |

列が欠損している場合はエラーメッセージが画面に表示され、処理は中断されます。

---

## 画面操作ガイド

### サイドバー（左側）

起動後、左サイドバーに以下の UI が表示されます。パラメータを変更すると画面全体が自動的に再計算されます。

#### データソース選択

**「アップロードファイルを使用」** または **「デフォルトファイルを使用」** をラジオボタンで切り替えます。

| 選択肢 | 動作 |
|--------|------|
| アップロードファイルを使用 | `.xlsx` ファイルのアップロードウィジェットが表示される。ファイル未選択時はガイドメッセージを表示 |
| デフォルトファイルを使用 | `data/20220916-koga-st-5cm-original-data.xlsx` を自動で読み込む |

#### 分析パラメータ

### メイン画面（各セクション）

#### 1. CH 別摩耗チャート

計測チャンネル（CH 1〜4）ごとの摩耗分布グラフです。

- **横軸**: キロ程（m）
- **縦軸**: 摩耗測定値（残存直径 mm）
- **ホバー**: データポイントにカーソルを合わせると以下の8項目が表示されます
  - 箇所名、通称線名名称、駅・駅々間名称、電柱番号
  - キロ程（小数第3位まで）、架線構造名、トロリ線種、降雨フラグ

Plotly の標準操作（ズーム・パン・凡例クリックによる表示切り替え）が使えます。

#### 2. フィルタ前後比較グラフ

生波形（元データ）とフィルタ後波形を同一グラフに重ねて表示します。
フィルタの効果（スパイクノイズ除去・平滑化）を視覚的に確認できます。

#### 3. 信号解析結果（RMS / FFT / STFT）

| グラフ | 横軸 | 縦軸 | 用途 |
|--------|------|------|------|
| スライドウィンドウ RMS | キロ程 | RMS 値 | 局所的なエネルギー変動の把握 |
| FFT 振幅スペクトル | 空間周波数（m⁻¹） | 振幅 | 支配的な周波数成分の特定 |
| STFT スペクトログラム | キロ程 × 空間周波数 | 振幅（カラー） | 周波数成分のキロ程方向変化 |

#### 4. 統合比較ビュー

生波形・フィルタ後波形・Z-Score プロットを **上下3段** に配置した連動グラフです。

- 3グラフの横軸（キロ程）が連動しており、**ズームとパンが同期** します
- Z-Score グラフ上に設定した **閾値ライン** が破線で表示されます
- 異常点（閾値超過）のキロ程値がホバーで確認できます

#### 5. 異常点ハイライト表示

フィルタ後波形上に Z-Score 閾値を超えた点を **マーカーでハイライト** します。
異常点がある場合は画面下部に **異常点一覧テーブル** も表示されます。

| テーブル列 | 内容 |
|-----------|------|
| キロ程 | 異常点の位置（m） |
| 摩耗_測定値 | その点の残存直径（mm） |
| 箇所名 | 設備箇所名 |
| 通称線名名称 | 線路名称 |
| 電柱番号 | 電柱番号 |
| Z-Score | 算出された Z-Score 値 |

---

## 分析パラメータ

| パラメータ | 設定範囲 | デフォルト | 説明 |
|-----------|---------|-----------|------|
| **ウィンドウ幅** | 1〜データ長（最大500） | 51 | 移動統計量の計算幅。大きいほど広域の傾向を捉える |
| **Z-Score 閾値** | 0.1〜10.0 | 2.5 | この値を超えた点を異常と判定。小さいほど検出が敏感になる |
| **移動中央値フィルタ** | ON / OFF | ON | スパイクノイズ除去。突発的な外れ値に強い |
| **Savitzky-Golay フィルタ** | ON / OFF | ON | 多項式フィッティングによる平滑化。波形の形状を保持しやすい |

### フィルタ適用順序

両フィルタが ON の場合: **移動中央値 → Savitzky-Golay** の順で適用されます。

### ウィンドウ幅の選び方

- **小さい値（例: 11〜31）**: 局所的な変動を捉える。細かい異常に敏感
- **大きい値（例: 51〜201）**: 広域の傾向を捉える。大きな摩耗トレンドの検出に適している
- Savitzky-Golay フィルタ向けに奇数補正が自動で行われます（偶数指定時は +1 補正）

---

## HTML 出力

メイン画面下部の **「HTML 出力」** セクションから、分析結果をファイルに保存できます。

| ボタン | 出力ファイル | 内容 |
|--------|------------|------|
| 統合比較ビューを HTML 出力 | `output/comparison_view.html` | 3段連動比較グラフ |
| 異常点ハイライトを HTML 出力 | `output/anomaly_overlay.html` | 異常点マーカー付き波形 |

出力ファイルはブラウザで直接開くことができ、Plotly のインタラクティブ操作（ズーム・パン・ホバー）がそのまま使えます。ファイルを同僚と共有することで、Streamlit アプリを起動せずに分析結果を確認できます。

---

## テスト実行

```bash
# 全テストを実行
uv run pytest

# カバレッジ付き実行
uv run pytest --cov=src

# 特定のモジュールのみ
uv run pytest tests/test_data_loader.py
uv run pytest tests/test_anomaly_detector.py
```

テストは 404 件あり、各コンポーネント（DataLoader, ParameterValidator, NoiseFilter, SignalAnalyzer, AnomalyDetector, Visualizer）のユニットテストとパイプライン統合テスト、ファイルアップロード機能テストを含みます。

---

## アーキテクチャ概要

3層パイプラインアーキテクチャを採用しています。

```
DataLayer        ProcessingLayer               PresentationLayer
──────────       ──────────────────────────    ──────────────────────────
DataLoader  -->  ParameterValidator            Visualizer  -->  StreamlitApp
                 NoiseFilter                               -->  HTML 出力
                 SignalAnalyzer
                 AnomalyDetector
```

各コンポーネントは単一の責務を持ち、独立してテスト可能です。
エラーは例外でなく値オブジェクト（`LoadError`, `InvalidWindowError` 等）として返されます。

### ソースファイル構成

```
app.py                    # Streamlit アプリ エントリポイント
src/
  data_loader.py          # Excel読み込み・列検証・CH分割
  parameter_validator.py  # ウィンドウ幅・閾値バリデーション
  noise_filter.py         # 移動中央値・Savitzky-Golay フィルタ
  signal_analyzer.py      # RMS・FFT・STFT 信号解析
  anomaly_detector.py     # Z-Score 異常検知
  visualizer.py           # Plotly グラフ生成・HTML 出力
tests/                    # ユニットテスト・統合テスト
data/                     # 計測データ Excel ファイル配置先
output/                   # HTML 出力先
```

---

## 将来拡張

現時点では主要機能が実装済みです。今後の拡張候補として以下が考えられます。

- **複数ファイル一括比較**: 複数の計測期間のデータを重ねて経年変化を可視化
- **摩耗トレンド予測**: 回帰分析による残余寿命推定
- **レポート自動生成**: 異常点一覧や統計サマリーを PDF／Excel 形式で出力
