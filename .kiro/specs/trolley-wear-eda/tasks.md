# 実装計画

## タスク一覧

- [x] 1. プロジェクト環境のセットアップ
- [x] 1.1 依存パッケージの定義と仮想環境構築
  - `pyproject.toml` を作成し、pandas 2.x、NumPy 1.26+、SciPy 1.17.1、Plotly 6.5.0、Streamlit、openpyxl を依存として記述する
  - `uv sync` で仮想環境を構築し、`uv run streamlit run app.py` で起動できることを確認する
  - _Requirements: 1.1_

- [x] 1.2 ディレクトリ構造とエントリポイントの骨格作成
  - `src/` ディレクトリに各コンポーネントの空モジュールファイル（`data_loader.py`, `noise_filter.py`, `signal_analyzer.py`, `anomaly_detector.py`, `visualizer.py`）を作成する
  - `app.py` を Streamlit アプリのエントリポイントとして作成する（起動のみ確認できる最小実装）
  - `output/` ディレクトリを HTML 出力先として用意する
  - _Requirements: 1.1_

---

- [x] 2. Excelデータの読み込みと列検証機能の実装
- [x] 2.1 (P) Excelファイルの読み込み処理の実装
  - `data/20220916-koga-st-5cm-original-data.xlsx` を pandas の openpyxl バックエンドで読み込む機能を実装する
  - ファイルが存在しない場合は "file_not_found" 種別のエラー値オブジェクトを返し、例外を外部に送出しない
  - 読み込みエラー（権限不足など）も同様にエラー値オブジェクトとして処理する
  - ファイルパスは `pathlib.Path` で正規化する
  - _Requirements: 1.1, 1.3_

- [x] 2.2 (P) 必須列の存在検証処理の実装
  - `キロ程`, `摩耗_測定値`, `CH`, `箇所名`, `通称線名名称`, `駅・駅々間名称`, `電柱番号`, `架線構造名`, `トロリ線種`, `降雨フラグ` の 10 列が DataFrame に存在するか検証する
  - 欠損列がある場合は欠損列名リストを含むエラー値オブジェクトを返す
  - 欠損列名は列挙してメッセージに含める
  - _Requirements: 1.2, 1.4_

- [x] 2.3 CH別グループ化機能の実装
  - CH 列（値 1〜4）で DataFrame をフィルタリングして個別 DataFrame を返す機能を実装する
  - CH 値が 1〜4 の範囲外の場合は空の DataFrame を返してログに記録する
  - _Requirements: 1.5_

---

- [x] 3. パラメータ検証機能の実装
- [x] 3.1 (P) ウィンドウ幅バリデーションの実装
  - ウィンドウ幅が `1 <= window_size <= len(data)` を満たすか検証する機能を実装する
  - 0 以下またはデータ長を超える値の場合は有効範囲を明示したエラー値オブジェクトを返す
  - Savitzky-Golay フィルタ向けに偶数ウィンドウ幅を +1 補正して奇数に揃える機能を実装する
  - _Requirements: 3.1, 3.6_

- [x] 3.2 (P) Z-Score閾値バリデーションの実装
  - Z-Score 閾値が正の実数であることを検証する機能を実装する
  - 無効な値の場合は正の実数を指定するよう案内するエラー値オブジェクトを返す
  - _Requirements: 5.3_

---

- [x] 4. ノイズフィルタリング機能の実装
- [x] 4.1 移動中央値フィルタの実装
  - pandas の rolling API を使って指定ウィンドウ幅の移動中央値を計算する機能を実装する
  - `min_periods=1`, `center=True` を設定してデータ端部でも途切れない連続波形を返す
  - _Requirements: 4.1, 4.3_

- [x] 4.2 Savitzky-Golayフィルタの実装
  - `scipy.signal.savgol_filter` を使って指定ウィンドウ幅・多項式次数でフィルタリングする機能を実装する
  - 呼び出し前に `window > polyorder` であることを確認し、条件違反時はエラーを明示する
  - ウィンドウ幅は ParameterValidator で奇数補正済みの値を受け取ることを前提とする
  - _Requirements: 4.2, 4.4_

- [x] 4.3 フィルタ適用順序制御と ON/OFF 切り替えの実装
  - FilterConfig（median_enabled, savgol_enabled フラグ）に従い、移動中央値 → Savitzky-Golay の順でフィルタを適用する機能を実装する
  - 両方 OFF の場合は入力データをそのまま返す
  - 元データと処理後データを保持した結果オブジェクトを返す
  - _Requirements: 4.3, 4.4, 4.5, 4.6_

---

- [x] 5. RMS・FFT・STFT信号解析機能の実装
- [x] 5.1 (P) スライドウィンドウRMSの実装
  - pandas rolling の `apply` を用いて `sqrt(mean(x**2))` を各ウィンドウに適用するスライドウィンドウ RMS を実装する
  - ウィンドウ幅は ParameterValidator で検証済みの値を受け取る
  - _Requirements: 3.2_

- [x] 5.2 (P) FFTスペクトル算出の実装
  - `numpy.fft.rfft` を使って指定ウィンドウ長の振幅スペクトルを計算する機能を実装する
  - 周波数軸は `rfftfreq(n, d=0.05)` で計算する（5cm = 0.05m ピッチ）
  - _Requirements: 3.3_

- [x] 5.3 (P) STFTスペクトログラム算出の実装
  - `scipy.signal.stft` を `nperseg=window_size` として呼び出し、時間-周波数スペクトルを算出する機能を実装する
  - `noverlap=window_size//2` を基本設定とする
  - _Requirements: 3.4_

---

- [x] 6. Z-Scoreによる異常検知機能の実装
- [x] 6.1 移動平均の算出実装
  - `rolling(window_size, min_periods=window_size).mean()` で移動平均を算出する機能を実装する
  - ウィンドウが満たない端部区間は NaN とする
  - _Requirements: 5.1_

- [x] 6.2 Z-Score算出と異常点記録の実装
  - 移動平均と移動標準偏差から `(x - μ) / σ` で Z-Score を算出する機能を実装する
  - 標準偏差がゼロの均一区間では除算エラーを防ぐために NaN を返す
  - ウィンドウが満たない区間は NaN として扱う（`min_periods=window_size`）
  - Z-Score が指定閾値を超えた計測点をインデックスおよびキロ程値とともに記録した結果オブジェクトを返す
  - _Requirements: 5.2, 5.4, 5.6_

---

- [x] 7. インタラクティブグラフ生成機能の実装
- [x] 7.1 CH別摩耗チャートの実装
  - CH 1〜4 それぞれの摩耗チャートを生成し、横軸をキロ程・縦軸を残存直径として描画する機能を実装する
  - 全 4 CH を一画面で確認できるレイアウト（サブプロット並列または切り替え表示）を実装する
  - `go.Scatter` の `hovertemplate` に `箇所名`, `通称線名名称`, `駅・駅々間名称`, `電柱番号`, `キロ程`（小数第3位まで）, `架線構造名`, `トロリ線種`, `降雨フラグ` の 8 項目を含める
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 7.2 フィルタ前後比較グラフの実装
  - フィルタ前の元波形とフィルタ後の波形を同一グラフ上に重ねて描画する機能を実装する
  - 横軸にキロ程、縦軸に残存直径を使用し、2 系列を色分けする
  - _Requirements: 4.7_

- [x] 7.3 信号解析結果グラフの実装
  - RMS 波形、FFT 振幅スペクトル、STFT スペクトログラムをそれぞれグラフ化する機能を実装する
  - 各グラフを適切な軸ラベル（日本語）付きで描画する
  - _Requirements: 3.5_

- [x] 7.4 統合3段比較ビューの実装
  - `make_subplots(rows=3, cols=1, shared_xaxes=True)` を使って生波形・フィルタ後波形・Z-Score プロットを上下3段に配置する機能を実装する
  - 3 グラフの横軸（キロ程）を連動させ、ズームおよびパン操作を同期する
  - Z-Score プロット上に閾値ラインを破線で表示する
  - 各データポイントのホバーにキロ程・測定値・Z-Score を表示する
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [x] 7.5 HTML出力機能の実装
  - `fig.write_html(output_path)` でインタラクティブグラフを HTML ファイルとして保存する機能を実装する
  - 出力先ディレクトリが存在しない場合は自動作成する
  - 出力ファイルの絶対パスを返す
  - _Requirements: 6.5_

---

- [x] 8. Streamlitアプリの統合実装
- [x] 8.1 サイドバーパラメータウィジェットの実装
  - サイドバーにウィンドウ幅スライダー（1〜データ長の範囲）、Z-Score 閾値入力、移動中央値フィルタ ON/OFF トグル、Savitzky-Golay フィルタ ON/OFF トグルを実装する
  - パラメータ変更のたびにパイプラインが再実行される Streamlit の仕組みを活用する
  - 不正なパラメータ値は `st.error()` / `st.warning()` で UI に表示する
  - _Requirements: 3.1, 3.6, 4.3, 4.4, 5.3_

- [x] 8.2 メイン画面へのグラフ描画統合
  - データ読み込み → フィルタリング → 異常検知 → 可視化のパイプライン全体を `app.py` から呼び出して `st.plotly_chart` でグラフを表示する機能を実装する
  - CH 別チャート、フィルタ前後比較グラフ、信号解析グラフ、統合比較ビューをそれぞれセクションとして表示する
  - HTML 出力ボタンを設置し、クリックで `output/` ディレクトリへ保存する
  - _Requirements: 1.1, 2.1, 2.2, 2.3, 2.4, 2.5, 3.5, 4.7, 5.5, 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 8.3 異常検知結果のグラフハイライト統合
  - AnomalyDetector が返した異常点インデックスを使って、グラフ上の該当データポイントをマーカーまたは色分けでハイライト表示する機能を統合する
  - ハイライトには閾値超過点のキロ程値を示す
  - _Requirements: 5.5_

---

- [ ] 9. ユニットテストと統合テストの実装
- [ ] 9.1 (P) DataLoaderのユニットテスト実装
  - 必須列がすべて揃っている場合・一部欠損の場合・全欠損の場合の列検証動作を検証するテストを実装する
  - ファイル未存在時のエラー返却を検証するテストを実装する
  - _Requirements: 1.2, 1.3, 1.4_

- [ ] 9.2 (P) ParameterValidatorのユニットテスト実装
  - 有効値・0・負値・データ長超過のウィンドウ幅バリデーション動作を検証するテストを実装する
  - 偶数・奇数・最小値（1）のウィンドウ幅補正動作を検証するテストを実装する
  - _Requirements: 3.1, 3.6_

- [ ] 9.3 (P) NoiseFilterのユニットテスト実装
  - 両方 OFF・移動中央値のみ ON・Savitzky-Golay のみ ON・両方 ON の 4 ケースの出力を検証するテストを実装する
  - _Requirements: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [ ] 9.4 (P) AnomalyDetectorのユニットテスト実装
  - ウィンドウ未満区間が NaN になること、ゼロ除算が NaN になることを検証するテストを実装する
  - 閾値超過点が正しく記録されることを検証するテストを実装する
  - _Requirements: 5.1, 5.2, 5.4, 5.6_

- [ ] 9.5 パイプライン統合テストの実装
  - DataLoader → NoiseFilter → AnomalyDetector のパイプライン全体を小規模 fixture DataFrame で実行し、AnomalyResult の型・不変条件を検証するテストを実装する
  - SignalAnalyzer の FFT・STFT 出力次元がウィンドウ幅に基づく期待値と一致することを検証するテストを実装する
  - Visualizer の統合比較ビューが 3 サブプロットを持つ Figure を返すことを検証するテストを実装する
  - _Requirements: 3.2, 3.3, 3.4, 5.1, 5.2, 5.4, 6.1_

- [ ]* 9.6 CH別チャートのホバーデータ検証テスト実装
  - CH 別チャートの `hovertemplate` に 8 項目（`箇所名`, `通称線名名称`, `駅・駅々間名称`, `電柱番号`, `キロ程`, `架線構造名`, `トロリ線種`, `降雨フラグ`）が含まれることを `fig.data` を解析して検証するテストを実装する
  - _Requirements: 2.3_

---

- [ ] 10. 将来拡張のための設計拡張点の明示
- [ ] 10.1 ファイルアップロード拡張点のスタブ実装
  - DataLoader の入力を抽象化し、`st.file_uploader` から受け取ったファイルオブジェクトを受け付けられる拡張インターフェースをスタブとして実装する
  - 非 Excel ファイル（.xlsx 以外）アップロード時のエラーメッセージ処理のスタブを実装する
  - 既存パイプラインコードを変更せずにアップロード機能を追加できることをコメントで明示する
  - _Requirements: 7.1, 7.2, 7.3, 7.4_
