# 要件ドキュメント

## はじめに

本ドキュメントは、**トロリ線摩耗検測データ（5cmピッチ生データ）探索的データ分析（EDA）ツール**の要件を定義します。

対象データは、架線設備に取り付けられたトロリ線の残存直径を連続的に計測したチャートデータです。ノイズが多い計測データから、局所的な摩耗（異常な直径低下）を正確に検知することを目的とします。

ツールは、データの可視化、統計処理の試験、ノイズフィルタリング、および異常検知をインタラクティブに実行するWebアプリケーションまたは分析スクリプトとして実現します。

---

## 要件

### 要件 1: データ読み込みと前提条件

**目標:** データアナリストとして、開発用サンプルデータ（Excelファイル）を読み込み、分析に必要な列が正しく取得できることを確認したい。そうすることで、後続の可視化・分析処理を安定して実行できる。

#### 受け入れ基準

1. The EDA Tool shall `data/20220916-koga-st-5cm-original-data.xlsx` ファイルを読み込み、DataFrameとして保持すること。
2. When データファイルを読み込む際, the EDA Tool shall 以下の列を含むことを検証すること: `キロ程`, `摩耗_測定値`, `CH`, `箇所名`, `通称線名名称`, `駅・駅々間名称`, `電柱番号`, `架線構造名`, `トロリ線種`, `降雨フラグ`。
3. If データファイルが存在しない場合, the EDA Tool shall ファイルが見つからない旨のエラーメッセージを出力し、処理を中断すること。
4. If 必須列が欠損している場合, the EDA Tool shall 欠損列名を列挙したエラーメッセージを出力すること。
5. The EDA Tool shall `CH` 列の値（1〜4）に基づいてデータをグループ化できること。

---

### 要件 2: データ可視化（CH別チャート）

**目標:** データアナリストとして、CH（1〜4）ごとに分割されたトロリ線摩耗チャートをインタラクティブに確認したい。そうすることで、キロ程に沿った摩耗の分布と局所的な異常を視覚的に把握できる。

#### 受け入れ基準

1. The EDA Tool shall CH（1〜4）ごとに個別のグラフを生成すること。
2. The EDA Tool shall 各グラフの横軸を `キロ程`、縦軸を `摩耗_測定値`（残存直径）として描画すること。
3. When グラフ上のデータポイントにホバーする, the EDA Tool shall 以下の情報をツールヒントとして表示すること: `箇所名`（日本語テキスト）、`通称線名名称`（日本語テキスト）、`駅・駅々間名称`（日本語テキスト）、`電柱番号`（文字列）、`キロ程`（小数第3位まで表示）、`架線構造名`（テキスト）、`トロリ線種`（テキスト）、`降雨フラグ`（文字列）。
4. The EDA Tool shall ズーム・パン等のインタラクティブ操作をサポートするグラフライブラリを使用すること。
5. The EDA Tool shall CHが1〜4のすべてについて、グラフを一画面に並べて（または切り替えて）確認できること。

---

### 要件 3: 統計処理のスライドウィンドウテスト

**目標:** データアナリストとして、スライドウィンドウによるRMS・FFT・STFT処理の効果を可変ウィンドウ幅で試験したい。そうすることで、ノイズ除去や周波数成分の把握に最適なパラメータを探索できる。

#### 受け入れ基準

1. The EDA Tool shall スライドウィンドウのウィンドウ幅をユーザが任意に変更できるパラメータとして提供すること。
2. When ウィンドウ幅が指定されると, the EDA Tool shall 指定幅のスライドウィンドウを用いてRMS（二乗平均平方根）処理を適用した波形を算出すること。
3. When ウィンドウ幅が指定されると, the EDA Tool shall 指定幅のスライドウィンドウを用いてFFT（高速フーリエ変換）処理を適用した周波数スペクトルを算出すること。
4. When ウィンドウ幅が指定されると, the EDA Tool shall 指定幅のスライドウィンドウを用いてSTFT（短時間フーリエ変換）処理を適用した時間-周波数スペクトルを算出すること。
5. The EDA Tool shall RMS・FFT・STFTのそれぞれの処理結果をグラフとして可視化すること。
6. If ウィンドウ幅が0以下または入力データ長を超える値として指定された場合, the EDA Tool shall 無効な値である旨の警告を出力すること。

---

### 要件 4: ノイズフィルタリング（前処理）

**目標:** データアナリストとして、計測エラーによるスパイクノイズを除去するフィルタリング処理をON/OFFで切り替えながら適用したい。そうすることで、真の摩耗パターンとノイズを分離し、後続の異常検知精度を向上できる。

#### 受け入れ基準

1. The EDA Tool shall 移動中央値フィルタをノイズ除去処理の一手法として実装すること。
2. The EDA Tool shall サビツキー・ゴーレイ（Savitzky-Golay）フィルタをノイズ除去処理の一手法として実装すること。
3. The EDA Tool shall 移動中央値フィルタのON/OFFをスイッチ（パラメータフラグ）で独立して制御できること。
4. The EDA Tool shall サビツキー・ゴーレイフィルタのON/OFFをスイッチ（パラメータフラグ）で独立して制御できること。
5. When 両フィルタがONの場合, the EDA Tool shall 移動中央値フィルタを先に適用し、その出力にサビツキー・ゴーレイフィルタを適用した結果を出力すること。
6. When フィルタがOFFの場合, the EDA Tool shall 元データをそのまま後続の処理に渡すこと。
7. The EDA Tool shall フィルタ処理後の波形をフィルタ前の波形と比較できるグラフを提供すること。

---

### 要件 5: 異常検知（移動平均からのZ-Score乖離）

**目標:** データアナリストとして、Z-Scoreに基づく急激な直径低下の検知結果を確認したい。そうすることで、局所的な摩耗異常箇所を定量的に特定できる。

#### 受け入れ基準

1. The EDA Tool shall フィルタ処理後のデータに対して移動平均を算出すること。
2. The EDA Tool shall 各計測点における移動平均からの乖離をZ-Scoreとして算出すること。
3. The EDA Tool shall 異常判定に使用するZ-Scoreの閾値をユーザが設定できるパラメータとして提供すること。
4. When Z-Scoreが閾値を超えた点が検出された場合, the EDA Tool shall その点を異常箇所として記録すること。
5. The EDA Tool shall 異常検知箇所をグラフ上でハイライト（例: マーカーや色分け）して表示すること。
6. If 指定されたウィンドウ幅内にデータ点が不足している場合, the EDA Tool shall その区間のZ-Score計算をスキップし、NaNまたは欠損として扱うこと。

---

### 要件 6: 統合インタラクティブ可視化（比較ビュー）

**目標:** データアナリストとして、元波形・フィルタ後波形・異常検知箇所を上下に並べたインタラクティブな比較グラフを確認したい。そうすることで、各処理段階の影響を一目で評価できる。

#### 受け入れ基準

1. The EDA Tool shall 元の波形（生データ）、フィルタ処理後の波形、異常検知箇所（Z-Scoreプロット）の3つのグラフを上下に並べて表示すること。
2. The EDA Tool shall 上下に並べた3グラフの横軸（キロ程）を連動させ、ズームおよびパン操作が同期すること。
3. The EDA Tool shall 異常検知箇所のグラフ上に閾値ラインを表示すること。
4. When グラフ上のデータポイントにホバーする, the EDA Tool shall キロ程および対応する測定値・Z-Scoreをツールヒントとして表示すること。
5. The EDA Tool shall グラフをHTML形式またはインタラクティブなNotebook出力として保存・共有できること。

---

### 要件 7: 将来拡張（ユーザによるデータアップロード）

**目標:** データアナリストとして、開発用サンプルデータだけでなく任意のExcelファイルをアップロードして分析を実行したい。そうすることで、異なる路線・区間のデータにも同一の分析パイプラインを適用できる。

#### 受け入れ基準

1. Where ファイルアップロード機能が実装された場合, the EDA Tool shall ユーザが任意のExcelファイル（.xlsx形式）をアップロードできるインターフェースを提供すること。
2. Where ファイルアップロード機能が実装された場合, the EDA Tool shall アップロードされたファイルに対して要件1と同様の列検証を実行すること。
3. Where ファイルアップロード機能が実装された場合, the EDA Tool shall アップロードされたファイルを用いて、要件2〜6で定義した分析パイプラインを実行できること。
4. If アップロードされたファイルがExcel形式でない場合, the EDA Tool shall 非対応形式である旨のエラーメッセージを表示すること。
