# 実装計画

## タスク一覧

- [x] 1. サイドバーにデータソース選択 UI を追加する
- [x] 1.1 データソース選択ラジオボタンとファイルアップロードウィジェットをサイドバーに配置する
  - サイドバーの先頭（既存の「分析パラメータ」ヘッダーより前）に「データソース選択」セクションを追加する
  - 選択肢「アップロードファイルを使用」「デフォルトファイルを使用」の2択ラジオボタンを配置し、初期選択を「アップロードファイルを使用」とする
  - 「アップロードファイルを使用」が選択されているときのみ、ラベル「分析ファイルを選択（.xlsx）」・許可拡張子 `.xlsx` 限定のファイルアップロードウィジェットを表示する
  - 「デフォルトファイルを使用」が選択されたときはファイルアップロードウィジェットを非表示にする
  - サイドバーの UI 定義順序を「データソース選択 → ファイルアップロードウィジェット（条件付き）→ 分析パラメータ」とし、すべてのサイドバーウィジェットをデータ取得処理より前に定義する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6_

- [x] 2. アップロードファイル読み込み用のキャッシュ関数を実装する
  - `app.py` のモジュールレベルに、`UploadedFile` オブジェクトを受け取って DataFrame または LoadError を返すキャッシュ関数を追加する
  - `@st.cache_data` デコレータを適用し、`UploadedFile` のファイル識別子をハッシュキーとして明示指定することで、同一ファイルの再読み込みを抑制する
  - 内部で既存の `DataLoader.load_from_upload()` を呼び出し、戻り値をそのまま返す（例外は外部に送出しない）
  - 異なるファイルがアップロードされると Streamlit が新しいオブジェクトを生成するため、キャッシュが自動無効化されることを確認する
  - _Requirements: 4.2, 4.3_

- [x] 3. エラーハンドリングとユーザーフィードバック表示を実装する
- [x] 3.1 ファイル未選択時のガード処理を実装する
  - 「アップロードファイルを使用」が選択されていてファイルが未選択の場合、ファイル選択を促すメッセージ（`st.info()`）を表示して `st.stop()` を呼び出す
  - ウィジェットのファイルがクリアされた場合も同様にメッセージ表示して停止し、デフォルトファイルへの自動復帰は行わない
  - _Requirements: 1.7, 5.4_

- [x] 3.2 LoadError の種別に応じたエラーメッセージ表示を実装する
  - `invalid_format` エラー時は「非対応のファイル形式です。.xlsx ファイルを指定してください。」に準ずるメッセージを `st.error()` で表示して `st.stop()` を呼び出す
  - `missing_columns` エラー時は欠損列名リストを含むエラーメッセージを `st.error()` で表示して `st.stop()` を呼び出す
  - `read_error` エラー時は読み込み失敗を示すエラーメッセージを `st.error()` で表示して `st.stop()` を呼び出す
  - エラー時は `st.stop()` によって分析パイプライン（フィルタリング・異常検知・可視化）の実行を完全に停止し、前回の分析結果が画面に残らないようにする
  - `st.error()` の呼び出し後に `st.stop()` を呼び出す順序を厳守する
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 4. データソース切り替えとパイプライン統合を実装する
- [x] 4.1 選択されたデータソースに応じたデータ取得ロジックを実装する
  - 「アップロードファイルを使用」選択時はキャッシュ関数経由でアップロードファイルを読み込み、DataFrame を取得する
  - 「デフォルトファイルを使用」選択時はデフォルトデータファイルのパスを既存の `load_data()` に渡して DataFrame を取得する
  - どちらの選択でも取得した DataFrame を既存パイプライン（NoiseFilter → AnomalyDetector → SignalAnalyzer → Visualizer）にそのまま渡す
  - 既存の分析パラメータウィジェット（ウィンドウ幅・Z-Score 閾値・フィルタ ON/OFF）の定義・動作を変更しない
  - _Requirements: 1.6, 4.1, 4.4, 5.1, 5.2_

- [x] 4.2 現在使用中のデータソースをメインエリアに表示する
  - アップロードファイル使用時はアップロードファイル名を、デフォルトファイル使用時は「デフォルトデータ」と示すテキストを、グラフ表示エリアの上部に表示する
  - _Requirements: 5.3_

- [ ] 5. `load_uploaded_data` キャッシュ関数のユニットテストを実装する (P)
  - 有効な xlsx ファイルオブジェクトを渡したとき DataFrame が返ることを検証する
  - 非 xlsx ファイルオブジェクトを渡したとき `LoadError(kind="invalid_format")` が返ることを検証する
  - 必須列が欠損したファイルオブジェクトを渡したとき `LoadError(kind="missing_columns")` が返ることを検証する
  - デフォルト選択時に既定のデータファイルパスが使用されることを検証する
  - タスク 2 の実装完了後に独立して作業できる。タスク 6 とは別ファイル（`tests/test_excel_file_registration.py`）を操作するため競合しない
  - _Requirements: 2.1, 2.3, 2.4, 4.2, 1.6, 5.1_

- [ ] 6. パイプライン統合テストと DataLoader 既存テストの動作確認を実装する
- [ ] 6.1 アップロードデータ経由のフルパイプライン統合テストを実装する
  - アップロードされた DataFrame が NoiseFilter に正しく渡されることを検証する
  - アップロードデータでフルパイプライン（NoiseFilter → AnomalyDetector → SignalAnalyzer → Visualizer）が完走することを検証する
  - `LoadError` が `app.py` のエラーハンドリングフローに正しく伝播することを検証する
  - タスク 4 の実装完了後に作業する
  - _Requirements: 4.1, 3.1, 3.2, 3.3, 3.4_

- [ ] 6.2 既存パラメータウィジェットの動作が変更されていないことを確認するテストを実装する
  - ファイルアップロード機能追加前後でウィンドウ幅・Z-Score 閾値・フィルタトグルのウィジェット動作が変化しないことを検証する
  - タスク 4 の実装完了後、`tests/test_app.py` を拡張して実施する
  - _Requirements: 4.4_

- [ ]* 6.3 DataLoader 既存テストのカバレッジを確認する
  - `tests/test_data_loader.py` の `TestLoadFromUploadInvalidFormat` と `TestLoadFromUploadValidFile` が引き続きパスすることを確認する（`uv run pytest tests/test_data_loader.py`）
  - 設計書で DataLoader の変更不要と確認済みのため、既存テストが変更なしにパスすれば対応完了とする
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_
