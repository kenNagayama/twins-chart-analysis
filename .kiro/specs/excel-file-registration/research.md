# リサーチ & 設計判断記録

---
**目的**: ディスカバリーフェーズで得た調査結果・アーキテクチャ検討・設計上の判断根拠を記録する。

---

## サマリー

- **フィーチャー**: `excel-file-registration`
- **ディスカバリースコープ**: Extension（既存システムへの拡張）
- **主要な調査結果**:
  - `DataLoader.load_from_upload()` は既にスタブ実装済みで、本要件が定義するエラー種別（`invalid_format` / `missing_columns` / `read_error`）も実装されている。`app.py` への UI 統合のみが未実装。
  - `app.py` のデータ読み込みフローは現在モジュールトップレベルに固定パスで記述されており、UI 選択による分岐制御が必要。`@st.cache_data` のキャッシュキーをファイル内容のハッシュ（`uploaded_file.file_id` 相当）で制御することで、同一ファイルの再読み込みを抑制できる。
  - Streamlit のセッションステート（`st.session_state`）を使わずとも、`@st.cache_data` デコレータの引数としてファイルオブジェクトそのものを渡すパターンが公式ドキュメントで推奨されている。

---

## リサーチログ

### トピック: `st.file_uploader` のキャッシュ戦略

- **背景**: 要件 4.2「アップロードファイルのデータ読み込みに `@st.cache_data` またはセッションステートを活用し、同一ファイルの再読み込みを抑制する」
- **参照文献**: Streamlit 公式ドキュメント（`st.file_uploader`, `st.cache_data`）
- **調査結果**:
  - `st.cache_data` に `UploadedFile` オブジェクトを直接渡すと、Streamlit がファイルオブジェクトをハッシュ化してキャッシュキーとして扱う。ファイルが変更されると新しいオブジェクトが生成されキャッシュが自動無効化される。
  - セッションステートへの手動格納は不要。シンプルな `@st.cache_data` デコレータで要件 4.2 と 4.3 を両立できる。
- **設計への影響**:
  - `load_uploaded_data(file_obj)` という `@st.cache_data` 付きキャッシュ関数を `app.py` に追加する。引数の `file_obj` は `st.file_uploader` の戻り値（`UploadedFile`）をそのまま渡す。

### トピック: `DataLoader.load_from_upload()` の既存実装確認

- **背景**: 要件 2.1〜2.6 に対応するメソッドが既に存在するかの確認
- **調査結果**:
  - `src/data_loader.py` の `load_from_upload(file_obj, filename)` は完全に実装済み。
  - 拡張子チェック（`invalid_format`）、Excel 読み込み（`read_error`）、列検証（`missing_columns`）の3種類のエラーが値として返される。
  - 既存テスト `tests/test_data_loader.py` の `TestLoadFromUploadInvalidFormat` / `TestLoadFromUploadValidFile` がすべてのエラーパターンをカバー済み。
- **設計への影響**:
  - `DataLoader` の変更は不要。`app.py` からの呼び出しインターフェースを設計するのみ。

### トピック: `app.py` 既存のデータ読み込み構造

- **背景**: 現在の固定パス読み込みとの統合方式の選定
- **調査結果**:
  - 現状の `load_data(file_path: str)` は `@st.cache_data` デコレータ付きでモジュールトップレベルで呼び出されている。
  - データソース選択 UI はサイドバーに配置するため、UI 描画 → データ読み込み → パイプライン実行の順に制御フローを再構成する必要がある。
  - 既存のサイドバーウィジェット（ウィンドウ幅・Z-Score 閾値・フィルタトグル）はデータロードとは独立しており、変更不要。
- **設計への影響**:
  - `app.py` の制御フローを「サイドバー UI → データ取得 → パラメータ UI → パイプライン」に整理する。データ取得部が失敗（`LoadError`）の場合は `st.error()` + `st.stop()` でパイプライン実行を停止する。

---

## アーキテクチャパターン評価

| 選択肢 | 説明 | 強み | リスク・制限 | 備考 |
|--------|------|------|------------|------|
| A: `app.py` 直接修正 | `app.py` 内でデータソース分岐ロジックを追加 | 変更範囲が最小限。既存パターンと一致 | `app.py` が肥大化する可能性 | 現在の規模なら許容範囲 |
| B: データソースアダプタクラス新設 | `DataSourceAdapter` を新しく作成し `app.py` から呼び出す | 責務分離が明確 | 今の要件に対して過剰設計 | 将来の拡張（S3、DB等）が想定される場合に検討 |

**選択**: 選択肢 A。現在の要件範囲（ローカルファイルとアップロードの2択）では `app.py` への直接追加が適切。ステアリング方針（`app.py` がパイプライン全体を統合するエントリポイント）にも合致する。

---

## 設計判断

### 判断: データソース選択 UI の配置

- **背景**: 要件 1.1〜1.7 — データソース選択 UI をどこに配置するか
- **検討した代替案**:
  1. メインエリアに配置 — 分析グラフの上に表示される
  2. サイドバーに配置 — 分析パラメータと同じ場所に集約
- **選択したアプローチ**: サイドバーに配置（要件 1.1 で「サイドバー内」と明示）
- **根拠**: 既存のパラメータ UI がサイドバーに集約されており一貫性がある。メインエリアはグラフ表示に専念できる。
- **トレードオフ**: サイドバーが縦に長くなるが、ユーザーの操作コンテキスト（「設定してから分析」）と一致する。
- **フォローアップ**: サイドバーの順序を「データソース選択 → ファイルアップロード → 分析パラメータ」とする。

### 判断: ファイルクリア時の挙動（デフォルトファイルへの自動復帰禁止）

- **背景**: 要件 5.4 — アップロードファイルをクリアした場合、デフォルトへ自動復帰しない
- **検討した代替案**:
  1. ファイルクリア時にデフォルトファイルへ自動的に切り替える
  2. ファイルクリア時はファイル選択を促すメッセージを表示して停止する
- **選択したアプローチ**: 選択肢 2（要件 5.4 で明示）
- **根拠**: ユーザーが意図的に「アップロードファイルを使用」を選択した状態なので、暗黙のフォールバックは混乱を招く。
- **トレードオフ**: ユーザーが意図せずファイルをクリアした場合に操作が止まるが、明示的な選択変更を促すことで意図の明確化になる。

### 判断: 現在使用中データソースの表示方法

- **背景**: 要件 5.3 — 現在使用中のデータソースを画面上に表示
- **選択したアプローチ**: `st.info()` または `st.caption()` をメインエリアのグラフ上部に表示する
- **根拠**: サイドバーに収めるとグラフを見ながら確認しにくい。メインエリアのグラフタイトル付近への表示が視認性を高める。

---

## リスクと緩和策

- **リスク1**: `st.cache_data` がファイルオブジェクトのハッシュ化に失敗する場合がある — Streamlit の `UploadedFile` は `Hashable` として扱われるが、将来のバージョンで変更される可能性がある。緩和: Streamlit のリリースノートを監視し、必要に応じて `hash_funcs` を指定する。
- **リスク2**: 大容量 Excel ファイルのアップロードによるメモリ消費 — 現在の分析対象は 5cm ピッチ計測データで通常数十 MB 以内と想定されるため、初期実装ではファイルサイズ上限設定は不要。
- **リスク3**: `st.file_uploader` の `type=["xlsx"]` フィルタはブラウザ側フィルタであり、サーバー側の検証は `DataLoader.load_from_upload()` の拡張子チェックで補完される。

---

## 参照文献

- [Streamlit st.file_uploader ドキュメント](https://docs.streamlit.io/library/api-reference/widgets/st.file_uploader) — ファイルアップロードウィジェットの API
- [Streamlit st.cache_data ドキュメント](https://docs.streamlit.io/library/advanced-features/caching) — キャッシュ戦略
- `src/data_loader.py` — `load_from_upload()` の既存実装（スタブコメント含む）
- `tests/test_data_loader.py` — `TestLoadFromUploadInvalidFormat` / `TestLoadFromUploadValidFile` — 既存テストカバレッジ
