# 要件定義書

## プロジェクト説明（入力）
エクセルでファイルを登録する機能を作りたい。

## はじめに

本要件定義書は、トロリ線摩耗検測データ分析ツール（5cm チャート分析）に対して、ユーザーが任意の Excel ファイル（.xlsx）をブラウザ上からアップロードして分析に使用できる「Excelファイル登録機能」を追加するための要件を定義する。

現状の `app.py` は固定パス（`data/20220916-koga-st-5cm-original-data.xlsx`）からデータを読み込む設計となっており、ユーザーが独自の計測データを投入できない。本機能の追加により、異なる路線・区間の計測データを同一パイプラインで分析できる拡張性を実現する。

---

## 要件

### 要件 1: データソース選択とファイルアップロードウィジェットの表示

**目的:** データアナリストとして、Streamlit アプリのサイドバーでデータソース（アップロードファイル／デフォルトファイル）を明示的に選択し、アップロードファイルを使用する場合はファイルアップロードウィジェットから Excel ファイルを登録したい。これにより、任意の計測データとサンプルデータを自在に切り替えて分析できる。

#### 受入基準
1. The アプリ shall サイドバー内にデータソース選択 UI（ラジオボタンまたはセレクトボックス）を表示する。選択肢は「アップロードファイルを使用」と「デフォルトファイルを使用」の2つとする。
2. The アプリ shall 初期状態のデータソース選択を「アップロードファイルを使用」とする。
3. When 「アップロードファイルを使用」が選択されている場合、the アプリ shall サイドバー内にファイルアップロードウィジェット（`st.file_uploader`）を表示する。
4. The アプリ shall ファイルアップロードウィジェットのラベルとして「分析ファイルを選択（.xlsx）」またはそれに準ずる日本語テキストを表示する。
5. The アプリ shall ファイルアップロードウィジェットの許可拡張子を `.xlsx` のみに制限する。
6. When 「デフォルトファイルを使用」が選択された場合、the アプリ shall ファイルアップロードウィジェットを非表示にし、デフォルトデータファイル（`data/20220916-koga-st-5cm-original-data.xlsx`）を使用して分析を実行する。
7. When 「アップロードファイルを使用」が選択されており、かつファイルがアップロードされていない場合、the アプリ shall ファイルの選択を促すメッセージを表示し、分析パイプラインを実行しない。

---

### 要件 2: アップロードファイルの読み込みと検証

**目的:** データアナリストとして、アップロードした Excel ファイルが正しく読み込まれ、必須10列の存在が検証されることを期待する。これにより、不正なファイルを誤って分析することを防止できる。

#### 受入基準
1. When ユーザーが `.xlsx` ファイルをアップロードした場合、the DataLoader shall `load_from_upload` メソッドを使用してファイルオブジェクトから DataFrame を読み込む。
2. When アップロードファイルの読み込みに成功した場合、the DataLoader shall 必須10列（キロ程、摩耗_測定値、CH、箇所名、通称線名名称、駅・駅々間名称、電柱番号、架線構造名、トロリ線種、降雨フラグ）の存在を検証する。
3. If `.xlsx` 以外のファイルがアップロードされた場合、the DataLoader shall `kind="invalid_format"` の `LoadError` を返す。
4. If 必須列が欠損している場合、the DataLoader shall `kind="missing_columns"` の `LoadError` を返し、欠損列名リストを `missing_columns` フィールドに格納する。
5. If Excel ファイルの解析に失敗した場合、the DataLoader shall `kind="read_error"` の `LoadError` を返す。
6. The DataLoader shall 読み込み・検証処理において例外を外部に送出せず、エラーを `LoadError` 値として返す。

---

### 要件 3: エラー時のユーザーフィードバック表示

**目的:** データアナリストとして、アップロードしたファイルに問題がある場合、具体的なエラーメッセージを画面上で確認したい。これにより、問題の原因を特定して適切なファイルを再投入できる。

#### 受入基準
1. If `LoadError(kind="invalid_format")` が返された場合、the アプリ shall `st.error()` を使用して「非対応のファイル形式です。.xlsx ファイルを指定してください。」に準ずるメッセージを表示する。
2. If `LoadError(kind="missing_columns")` が返された場合、the アプリ shall `st.error()` を使用して欠損列名を含むエラーメッセージを表示する。
3. If `LoadError(kind="read_error")` が返された場合、the アプリ shall `st.error()` を使用してエラーメッセージを表示する。
4. While エラーメッセージが表示されている場合、the アプリ shall 分析パイプライン（フィルタリング・異常検知・可視化）の実行を停止する（`st.stop()` を呼び出す）。
5. When エラーが発生した場合、the アプリ shall 前回の正常なデータによる分析結果を画面に残さず、エラーメッセージのみを表示する。

---

### 要件 4: アップロード成功時のデータパイプライン統合

**目的:** データアナリストとして、アップロードした Excel ファイルのデータが既存の分析パイプライン（ノイズフィルタリング・異常検知・可視化）にシームレスに引き渡されることを期待する。これにより、追加操作なしに分析結果を確認できる。

#### 受入基準
1. When アップロードファイルの読み込みと列検証が成功した場合、the アプリ shall 取得した DataFrame を既存パイプライン（`NoiseFilter`、`AnomalyDetector`、`SignalAnalyzer`、`Visualizer`）にそのまま渡す。
2. The アプリ shall アップロードファイルのデータ読み込みに `@st.cache_data` またはセッションステートを活用し、同一ファイルの再読み込みを抑制する。
3. When 異なるファイルがアップロードされた場合、the アプリ shall キャッシュを無効化して新しいファイルのデータで分析を更新する。
4. The アプリ shall ファイルアップロード機能追加後も、既存の分析パラメータウィジェット（ウィンドウ幅、Z-Score 閾値、フィルタ ON/OFF）を、データソース選択やファイルのアップロード状態にかかわらず常にサイドバーに表示し、動作を変更しない。

---

### 要件 5: データソース切り替え動作

**目的:** データアナリストとして、データソース選択 UI でアップロードファイルとデフォルトファイルを明示的に切り替えられることを期待する。これにより、サンプルデータと独自データを意図的に使い分けて分析できる。

#### 受入基準
1. When ユーザーがデータソース選択を「デフォルトファイルを使用」に変更した場合、the アプリ shall アップロード済みファイルの有無にかかわらず、デフォルトデータファイル（`data/20220916-koga-st-5cm-original-data.xlsx`）を使用して分析を実行する。
2. When ユーザーがデータソース選択を「アップロードファイルを使用」に変更した場合、the アプリ shall アップロード済みファイルが存在すればそのファイルを使用し、存在しなければファイル選択を促すメッセージを表示する。
3. The アプリ shall 現在使用中のデータソース（アップロードファイル名 または「デフォルトデータ」）を画面上に表示する。
4. When 「アップロードファイルを使用」が選択されている状態でユーザーがウィジェットのファイルをクリアした場合、the アプリ shall デフォルトファイルへ自動復帰せず、ファイル選択を促すメッセージを表示して分析パイプラインを停止する。
